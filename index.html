<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taco Gato</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #1a1a1a;
  color: #fff;
  text-align: center;
}
#estado {
  padding: 20px;
  font-size: 1.5rem;
  font-weight: bold;
  background: #222;
}
#btn {
  flex: 1;
  font-size: 3rem;
  background: #ff4757;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}
#controles {
  display: flex;
  gap: 5px;
  padding: 10px;
}
button {
  flex: 1;
  padding: 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: white;
  font-weight: bold;
}
#historial {
  height: 200px;
  overflow-y: auto;
  background: #000;
  padding: 10px;
  font-family: monospace;
  text-align: left;
}
.perdedor {
  color: #ff4757;
  font-weight: bold;
  border: 1px solid #ff4757;
  padding: 2px 5px;
  margin-left: 10px;
}
</style>
</head>

<body>

<div id="estado">Cargando...</div>
<button id="btn" disabled>¡MANOTAZO!</button>

<div id="controles">
  <button id="reset" style="background:#2ed573;">Nueva Ronda</button>
  <button id="changeMax" style="background:#ffa502;">Cambiar Jugadores</button>
</div>

<div id="historial"></div>
<audio id="golpe">
  <source src="golpe.mp3" type="audio/mpeg">
</audio>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "taco-gato-demo",
  authDomain: "taco-gato-eee4b.firebaseapp.com",
  databaseURL: "https://taco-gato-eee4b-default-rtdb.firebaseio.com",
  projectId: "taco-gato-eee4b",
  appId: "1:128509807550:web:e1daba4a406764fe2d87ef"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const salaId = "partida_global";
const partidaRef = ref(db, `salas/${salaId}`);

let nombre = localStorage.getItem("usuario");
if (!nombre) {
  nombre = prompt("Tu nombre para jugar:");
  if (!nombre) nombre = "Jugador" + Math.floor(Math.random() * 100);
  localStorage.setItem("usuario", nombre);
}

const btn = document.getElementById("btn");
const estadoEl = document.getElementById("estado");
const historialEl = document.getElementById("historial");

async function configurarNuevaPartida() {
  let n = prompt("¿Cuántas personas van a jugar?");
  let max = parseInt(n);

  if (!Number.isInteger(max) || max <= 0) {
    max = 3;
  }

  await set(partidaRef, {
    max: max,
    clicks: {}
  });
}

const snap = await get(partidaRef);
if (!snap.exists()) {
  await configurarNuevaPartida();
}

onValue(partidaRef, (snapshot) => {
  const data = snapshot.val();

  if (!data || !data.max) {
    configurarNuevaPartida();
    return;
  }

  const clicks = data.clicks ? Object.values(data.clicks) : [];
  const yaClick = clicks.includes(nombre);
  const terminada = clicks.length >= data.max;

  btn.disabled = yaClick || terminada;

  btn.innerText = yaClick
    ? "ESPERANDO..."
    : terminada
      ? "RONDA CERRADA"
      : "¡MANOTAZO!";

  btn.style.background = btn.disabled ? "#333" : "#ff4757";

  estadoEl.innerText = terminada
    ? "¡RONDA CERRADA!"
    : `Jugadores: ${clicks.length} / ${data.max}`;

  historialEl.innerHTML = clicks.map((n, i) => {
    const esUltimo = i === data.max - 1;
    return `<div>${i+1}. ${n} ${esUltimo ? '<span class="perdedor">¡PIERDE!</span>' : ''}</div>`;
  }).join("");
});

btn.onclick = async () => {

  if (navigator.vibrate) {
    navigator.vibrate(200);
  }

  const sonido = document.getElementById("golpe");
  sonido.currentTime = 0;
  sonido.play();

  const clickRef = ref(db, `salas/${salaId}/clicks`);
  await push(clickRef, nombre);

};




document.getElementById("reset").onclick = async () => {
  const snapshot = await get(ref(db, `salas/${salaId}/max`));
  const maxActual = snapshot.val() || 3;

  await set(partidaRef, {
    max: maxActual,
    clicks: {}
  });
};

document.getElementById("changeMax").onclick = () => {
  configurarNuevaPartida();
};

</script>

</body>
</html>
